<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Napzak Chat WebSocket Tester</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #log { height: 320px; overflow-y: auto; background: #111; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; }
        label { display:block; margin-top: 10px; }
        input[type=text] { width: 100%; }
        button { margin-right: 5px; margin-top: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>Napzak Chat WebSocket Tester</h2>

<label>WebSocket URL ("ws://localhost:8080/ws/v1")
    <input id="url" type="text" value="ws://localhost:8080/ws/v1" />
</label>
<label>JWT (Bearer ì œì™¸)
    <input id="token" type="text" placeholder="eyJhbGciOi..." />
</label>
<label>Room ID
    <input id="roomId" type="text" value="1" />
</label>
<label>ë©”ì‹œì§€ ë‚´ìš©
    <input id="outMsg" type="text" />
</label>

<div>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <button onclick="subscribeRoom()">Subscribe</button>
    <button onclick="sendMessage()">Send</button>
    <button onclick="subscribePong()">Subscribe Pong</button>
    <button onclick="sendPing()">Ping</button>
</div>

<pre id="log"></pre>

<script>
    let client = null;
    let connected = false;

    function log(message) {
        const el = document.getElementById('log');
        el.textContent += message + "\n";
        el.scrollTop = el.scrollHeight;
    }

    function connect() {
        if (connected) { log("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤"); return; }
        const baseUrl = document.getElementById('url').value;
        const token = document.getElementById('token').value.trim();

        // ğŸ”‘ í† í°ì€ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ (ë¸Œë¼ìš°ì €ëŠ” WebSocket í•¸ë“œì…°ì´í¬ì— ì»¤ìŠ¤í…€ í—¤ë” ë¶ˆê°€)
        const wsUrl = `${baseUrl}?token=${encodeURIComponent(token)}`;
        const ws = new WebSocket(wsUrl);

        client = Stomp.over(ws);
        client.debug = null; // í•„ìš”í•˜ë©´ console ë¡œê·¸ í™œì„±í™”

        // ğŸ’“ í•˜íŠ¸ë¹„íŠ¸ ì„¤ì • ì¶”ê°€
        client.heartbeat.outgoing = 10000;
        client.heartbeat.incoming = 10000;

        client.connect({}, frame => {
                connected = true;
                log("âœ… CONNECTED\n" + (frame.headers['server'] || ''));
                subscribeRoom();
            }, err => {
                log("âŒ CONNECT ERROR: " + JSON.stringify(err));
            }
        );
    }

    function disconnect() {
        if (client && connected) {
            client.disconnect(() => {
                log("ğŸšª DISCONNECTED");
                connected = false;
            });
        }
    }

    function subscribeRoom() {
        if (!connected) { log("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”"); return; }
        const roomId = document.getElementById('roomId').value;
        client.subscribe(`/topic/chat.room.${roomId}`, msg => {
            log(`ğŸ“© ${msg.body}`);
        });
        log(`ğŸ”” SUBSCRIBED /topic/chat.room.${roomId}`);
    }

    function sendMessage() {
        if (!connected) { log("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”"); return; }
        const roomId = document.getElementById('roomId').value;
        const content = document.getElementById('outMsg').value;
        const payload = {
            roomId: parseInt(roomId),
            type: "TEXT",
            content,
            metadata: null
        };
        client.send('/pub/chat.send', {}, JSON.stringify(payload));
        log(`â¡ï¸ SENT: ${JSON.stringify(payload)}`);
    }

    function subscribePong() {
        if (!connected) { log("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”"); return; }
        client.subscribe("/topic/pong", msg => {
            log(`ğŸ”¥ PONG received: ${msg.body}`);
        });
        log("ğŸ”” SUBSCRIBED /topic/pong");
    }

    function sendPing() {
        if (!connected) { log("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”"); return; }
        client.send('/pub/ping', {}, {});
        log('ğŸ“ PING');
    }
</script>
</body>
</html>
